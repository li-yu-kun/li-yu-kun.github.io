<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          [Flink] DataSet API编程 - 李玉坤 | Blog
        
    </title>

    <link rel="canonical" href="https://li-yu-kun.github.io/article/[Flink] DataSet API编程/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/article_header/article_bg.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                        </div>
                        <h1>[Flink] DataSet API编程</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 李玉坤 on
                            2020-04-27
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">李玉坤</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>本博客以scala编程概念为主</p>
<h1 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h1><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/batch/" target="_blank" rel="noopener">官网链接</a><br>Flink中的DataSet程序是常规程序，可对数据集进行转换（filtering, mapping, joining, grouping）。最初从某些来源(sources)（by reading files, or from local collections）创建数据集。结果通过接收器返回，接收器可以例如<strong>将数据写入（分布式）文件或标准输出</strong>（例如命令行终端）。Flink程序可以在各种上下文中运行，独立运行或嵌入其他程序中。执行可以在本地JVM或许多计算机的群集中进行。</p>
<p><strong>Source=&gt;Flink(transformations)=&gt;sink</strong></p>
<h1 id="2、flink综合java和scala开发的项目构建creenflow"><a href="#2、flink综合java和scala开发的项目构建creenflow" class="headerlink" title="2、flink综合java和scala开发的项目构建creenflow"></a>2、flink综合java和scala开发的项目构建creenflow</h1><p>1、创建一个空的scala工程<br>2、pom文件里添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.9.0<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scala.binary.version</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">scala.binary.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scala.version</span>&gt;</span>2.11.12<span class="tag">&lt;/<span class="name">scala.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以在项目中新建java包；完整项目结构如下：<br><img src="1.png" alt=""></p>
<h1 id="3、Data-Source概述"><a href="#3、Data-Source概述" class="headerlink" title="3、Data Source概述"></a>3、Data Source概述</h1><h2 id="1、基于文件"><a href="#1、基于文件" class="headerlink" title="1、基于文件"></a>1、基于文件</h2><ul>
<li><p>readTextFile(path)/ TextInputFormat-逐行读取文件，并将它们作为字符串返回。</p>
</li>
<li><p>readTextFileWithValue(path)/ TextValueInputFormat-逐行读取文件，并将它们作为StringValues返回。StringValues是可变字符串。</p>
</li>
<li><p>readCsvFile(path)/ CsvInputFormat-解析以逗号（或其他字符）分隔的字段的文件。返回元组，案例类对象或POJO的数据集。支持基本的Java类型及其与Value相对应的字段类型。</p>
</li>
<li><p>readFileOfPrimitives(path, delimiter)// PrimitiveInputFormat-解析以换行符（或其他char序列）定界的原始数据类型的文件，例如String或Integer使用给定的定界符。</p>
</li>
<li><p>readSequenceFile(Key, Value, path)// SequenceFileInputFormat-创建JobConf并从指定的路径中读取类型为SequenceFileInputFormat，Key类和Value类的文件，并将它们作为Tuple2 &lt;Key，Value&gt;返回。</p>
<h2 id="2、基于集合"><a href="#2、基于集合" class="headerlink" title="2、基于集合"></a>2、基于集合</h2></li>
<li><p>fromCollection(Iterable)-从Iterable创建数据集。Iterable返回的所有元素都必须是同一类型。</p>
</li>
<li><p>fromCollection(Iterator)-从迭代器创建数据集。该类指定迭代器返回的元素的数据类型。</p>
</li>
<li><p>fromElements(elements: _*)-从给定的对象序列创建数据集。所有对象必须具有相同的类型。</p>
</li>
<li><p>fromParallelCollection(SplittableIterator)-从迭代器并行创建数据集。该类指定迭代器返回的元素的数据类型。</p>
</li>
<li><p>generateSequence(from, to) -并行生成给定间隔中的数字序列。</p>
</li>
</ul>
<h2 id="3、通用"><a href="#3、通用" class="headerlink" title="3、通用"></a>3、通用</h2><ul>
<li><p>readFile(inputFormat, path)/ FileInputFormat-接受文件输入格式。</p>
</li>
<li><p>createInput(inputFormat)/ InputFormat-接受通用输入格式。</p>
<h1 id="4、从集合创建DataSet的scala实现"><a href="#4、从集合创建DataSet的scala实现" class="headerlink" title="4、从集合创建DataSet的scala实现"></a>4、从集合创建DataSet的scala实现</h1></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala._</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">object DataSetDataSourceApp &#123;</span><br><span class="line">  <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line">    fromCollection(env)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">def <span class="title">fromCollection</span><span class="params">(env: ExecutionEnvironment)</span>: Unit </span>= &#123;</span><br><span class="line">    val data = <span class="number">1</span> to <span class="number">10</span></span><br><span class="line">    env.fromCollection(data).print()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<h1 id="5、从集合创建DataSet的java实现"><a href="#5、从集合创建DataSet的java实现" class="headerlink" title="5、从集合创建DataSet的java实现"></a>5、从集合创建DataSet的java实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaDataSetDataSourceApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        fromCollection(env);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fromCollection</span><span class="params">(ExecutionEnvironment env)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        env.fromCollection(list).print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<h1 id="6、从文件创建DataSet的scala实现"><a href="#6、从文件创建DataSet的scala实现" class="headerlink" title="6、从文件创建DataSet的scala实现"></a>6、从文件创建DataSet的scala实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line">    textFile(env)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">def <span class="title">textFile</span><span class="params">(env:ExecutionEnvironment)</span>:Unit </span>= &#123;</span><br><span class="line">  <span class="comment">//可以是也给文件也可以是一个文件夹</span></span><br><span class="line">    val filePath=<span class="string">"test_files\\test_file\\test01.txt"</span></span><br><span class="line">    env.readTextFile(filePath).print()</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">hello,welcome</span><br><span class="line">hello,world,welcome</span><br></pre></td></tr></table></figure>
<h1 id="7、从文件创建DataSet的java实现"><a href="#7、从文件创建DataSet的java实现" class="headerlink" title="7、从文件创建DataSet的java实现"></a>7、从文件创建DataSet的java实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        textFile(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">textFile</span><span class="params">(ExecutionEnvironment env)</span> </span>&#123;</span><br><span class="line">        String filePath=<span class="string">"test_files\\test_file"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            env.readTextFile(filePath).print();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">hello,welcome</span><br><span class="line">hello,world,welcome</span><br></pre></td></tr></table></figure>
<h1 id="8、从csv文件创建DataSet的scala实现"><a href="#8、从csv文件创建DataSet的scala实现" class="headerlink" title="8、从csv文件创建DataSet的scala实现"></a>8、从csv文件创建DataSet的scala实现</h1><p>原始数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name,age,job</span><br><span class="line">zhangsan,30,Developer</span><br><span class="line">lisi,32,Developer</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这一行代码是在类的外部</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> class <span class="title">MyCaseClass</span><span class="params">(name:String,age:Int)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line">    csvFile(env)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">def <span class="title">csvFile</span><span class="params">(env: ExecutionEnvironment)</span>: Unit </span>= &#123;</span><br><span class="line">    val filePath = <span class="string">"test_files\\test_csv"</span></span><br><span class="line">    <span class="comment">//ignoreFirstLine=true表示忽略第一行；readCsvFile源码有解释</span></span><br><span class="line">    env.readCsvFile[(String, Int, String)](filePath, ignoreFirstLine = <span class="keyword">true</span>).print()</span><br><span class="line">    env.readCsvFile[(String, Int)](filePath, ignoreFirstLine = <span class="keyword">true</span>).print()</span><br><span class="line">    env.readCsvFile[(String, Int)](filePath, ignoreFirstLine = <span class="keyword">true</span>,includedFields=Array(<span class="number">0</span>,<span class="number">1</span>)).print()</span><br><span class="line">    env.readCsvFile[MyCaseClass](filePath, ignoreFirstLine = <span class="keyword">true</span>,includedFields=Array(<span class="number">0</span>,<span class="number">1</span>)).print()  </span><br><span class="line">    env.readCsvFile[Person](filePath, ignoreFirstLine = <span class="keyword">true</span>,pojoFields=Array(<span class="string">"name"</span>,<span class="string">"age"</span>,<span class="string">"work"</span>)).print()</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">(lisi,<span class="number">32</span>,Developer)</span><br><span class="line">(zhangsan,<span class="number">30</span>,Developer)</span><br><span class="line"></span><br><span class="line">(lisi,<span class="number">32</span>)</span><br><span class="line">(zhangsan,<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">(zhangsan,<span class="number">30</span>)</span><br><span class="line">(lisi,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">MyCaseClass(zhangsan,<span class="number">30</span>)</span><br><span class="line">MyCaseClass(lisi,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">Person&#123;name=<span class="string">'zhangsan'</span>, age=<span class="number">30</span>, work=<span class="string">'Developer'</span>&#125;</span><br><span class="line">Person&#123;name=<span class="string">'lisi'</span>, age=<span class="number">32</span>, work=<span class="string">'Developer'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>其中pojo类为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String work;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">", work='"</span> + work + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> work;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWork</span><span class="params">(String work)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.work = work;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="8、从递归文件夹创建DataSet的scala实现"><a href="#8、从递归文件夹创建DataSet的scala实现" class="headerlink" title="8、从递归文件夹创建DataSet的scala实现"></a>8、从递归文件夹创建DataSet的scala实现</h1><p>文件夹结构<br><img src="2.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line">    readRecursiveFiles(env)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">def <span class="title">readRecursiveFiles</span><span class="params">(env: ExecutionEnvironment)</span>:Unit</span>=&#123;</span><br><span class="line">    val filePath=<span class="string">"test_files\\test_file"</span></span><br><span class="line">    <span class="comment">//默认不使用递归</span></span><br><span class="line">    env.readTextFile(filePath).print()</span><br><span class="line">    println(<span class="string">"======================"</span>)</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//使用递归</span></span><br><span class="line">    val parameters = <span class="keyword">new</span> Configuration</span><br><span class="line">    parameters.setBoolean(<span class="string">"recursive.file.enumeration"</span>, <span class="keyword">true</span>)</span><br><span class="line">    env.readTextFile(filePath).withParameters(parameters).print()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hello,world,welcome</span><br><span class="line">hello,welcome</span><br><span class="line">======================</span><br><span class="line">hello,welcome</span><br><span class="line">hello,world,welcome</span><br><span class="line">hello,welcome</span><br><span class="line">hello,world,welcome</span><br></pre></td></tr></table></figure>
<h1 id="9、从压缩文件创建DataSet的scala实现"><a href="#9、从压缩文件创建DataSet的scala实现" class="headerlink" title="9、从压缩文件创建DataSet的scala实现"></a>9、从压缩文件创建DataSet的scala实现</h1><p>如果输入文件标记有适当的文件扩展名，Flink当前支持自动的对输入文件解压缩。特别是，这意味着无需进一步配置输入格式，并且不需要任何FileInputFormat压缩支持，包括自定义输入格式。请注意，压缩文件可能无法并行读取，从而影响作业的可伸缩性。</p>
<h1 id="10，transformation"><a href="#10，transformation" class="headerlink" title="10，transformation"></a>10，transformation</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>数据转换将一个或多个数据集转换为新的数据集。程序可以将多种转换组合成复杂的程序集。</p>
<h2 id="2、map函数"><a href="#2、map函数" class="headerlink" title="2、map函数"></a>2、map函数</h2><p>获取一个元素并生成一个元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.map &#123; x =&gt; x.toInt &#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、Filter函数"><a href="#3、Filter函数" class="headerlink" title="3、Filter函数"></a>3、Filter函数</h2><p>为每个元素计算布尔函数，并保留函数返回true的元素。</p>
<p>重要提示:系统假设函数不修改应用谓词的元素。违反这一假设可能导致不正确的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.filter &#123; _ &gt; <span class="number">1000</span> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="4、MapPartition函数"><a href="#4、MapPartition函数" class="headerlink" title="4、MapPartition函数"></a>4、MapPartition函数</h2><p>在单个函数调用中转换并行分区。函数以“迭代器”的形式获取分区，并可以生成任意数量的结果值。每个分区中的元素数量取决于并行度和以前的操作。<br>常用于输出到数据库里；比如输出到MySQL会调用同等分区数的connection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.mapPartition &#123; in =&gt; in map &#123; (_, <span class="number">1</span>) &#125; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5、First-n函数"><a href="#5、First-n函数" class="headerlink" title="5、First-n函数"></a>5、First-n函数</h2><p>返回数据集的第一个n(任意)元素。第一个n可以应用于常规数据集、分组数据集或分组排序数据集。分组键可以指定为键选择器函数、元组位置或case类字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val in: DataSet[(Int, String)] = <span class="comment">// [...]</span></span><br><span class="line"><span class="comment">// 返回前三个</span></span><br><span class="line">val result1 = in.first(<span class="number">3</span>)</span><br><span class="line"><span class="comment">// 按照key分组后求每组的前3个</span></span><br><span class="line">val result2 = in.groupBy(<span class="number">0</span>).first(<span class="number">3</span>)</span><br><span class="line"><span class="comment">// 按照key分组后对于每组按照value做升序排序</span></span><br><span class="line">val result3 = in.groupBy(<span class="number">0</span>).sortGroup(<span class="number">1</span>, Order.ASCENDING).first(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h2 id="6、FlatMap函数"><a href="#6、FlatMap函数" class="headerlink" title="6、FlatMap函数"></a>6、FlatMap函数</h2><p>获取一个元素并生成零个、一个或多个元素。<br>可以把string类型的list压扁成一个string</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//data是一个集合类型；</span></span><br><span class="line">data.flatMap &#123; str =&gt; str.split(<span class="string">" "</span>) &#125;</span><br><span class="line"><span class="comment">//比如求一个list的以逗号分隔的集合的单词次数</span></span><br><span class="line">data.flatMap(_.split(<span class="string">","</span>)).map((_,<span class="number">1</span>)).groupBy(<span class="number">0</span>).sum(<span class="number">1</span>).print()</span><br></pre></td></tr></table></figure>
<h2 id="6、Distinct函数"><a href="#6、Distinct函数" class="headerlink" title="6、Distinct函数"></a>6、Distinct函数</h2><p>返回数据集中不同的元素。它从输入数据集中删除与元素的所有字段或字段子集相关的重复条目。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.distinct ()</span><br></pre></td></tr></table></figure>
<h2 id="7、join函数（内链接）"><a href="#7、join函数（内链接）" class="headerlink" title="7、join函数（内链接）"></a>7、join函数（内链接）</h2><p>通过创建键上相等的所有成对的元素来联接两个数据集。使用JoinFunction将一对元素转换为单个元素，或者使用FlatJoinFunction将一对元素转换为任意多个（包括无元素）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在这种情况下，元组字段用作键。“0”是第一个元组的join字段，"1"是第二个元组的join字段。</span></span><br><span class="line">val result = input1.join(input2).where(<span class="number">0</span>).equalTo(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>您可以通过连接提示指定运行时执行连接的方式。这些提示描述了连接是通过分区还是广播进行的，以及连接是使用基于排序的算法还是基于散列的算法。<br>如果没有指定提示，系统将尝试估计输入大小，并根据这些估计选择最佳策略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过广播第一个数据集执行连接</span></span><br><span class="line"><span class="comment">//对广播数据使用哈希表</span></span><br><span class="line">val result = input1.join(input2, JoinHint.BROADCAST_HASH_FIRST).where(<span class="number">0</span>).equalTo(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="8、OuterJoin函数（外连接）"><a href="#8、OuterJoin函数（外连接）" class="headerlink" title="8、OuterJoin函数（外连接）"></a>8、OuterJoin函数（外连接）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">val joined = left.leftOuterJoin(right).where(<span class="number">0</span>).equalTo(<span class="number">1</span>) &#123;</span><br><span class="line">   (left, right) =&gt;</span><br><span class="line">     val a = <span class="keyword">if</span> (left == <span class="keyword">null</span>) <span class="string">"none"</span> <span class="keyword">else</span> left._1</span><br><span class="line">     (a, right)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//全连接</span></span><br><span class="line">val joined = left.fullOuterJoin(right).where(<span class="number">0</span>).equalTo(<span class="number">1</span>) &#123;</span><br><span class="line">   (left, right) =&gt;&#123;</span><br><span class="line">   <span class="keyword">if</span>(left == <span class="keyword">null</span>)&#123;</span><br><span class="line">      (<span class="string">"_"</span>,right)</span><br><span class="line">     &#125;<span class="keyword">else</span> <span class="keyword">if</span> (right == <span class="keyword">null</span>)&#123;</span><br><span class="line">      (left,<span class="string">"_"</span>)</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      (left,right)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="9、Cross函数"><a href="#9、Cross函数" class="headerlink" title="9、Cross函数"></a>9、Cross函数</h2><p>构建两个输入的笛卡尔积(叉乘)，创建所有对元素。可选地使用交叉函数将一对元素转换为单个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val data1: DataSet[Int] = <span class="comment">// [1,2,3]3个元素</span></span><br><span class="line">val data2: DataSet[String] = <span class="comment">// [a,b]2个元素</span></span><br><span class="line"><span class="comment">//cross后结果会是6个元素  (1,a)(1,b)(2,a)(2,b)(3,a)(3,b)</span></span><br><span class="line">val result: DataSet[(Int, String)] = data1.cross(data2)</span><br></pre></td></tr></table></figure>
<h1 id="11、Data-Sinks（数据输出）"><a href="#11、Data-Sinks（数据输出）" class="headerlink" title="11、Data Sinks（数据输出）"></a>11、Data Sinks（数据输出）</h1><p>Flink自带多种内置输出格式，当然也可以自定义输出格式</p>
<p>内置的输出格式：</p>
<ul>
<li>writeAsText()/ TextOutputFormat-将元素按行写为字符串。通过调用每个元素的toString（）方法获得字符串。</li>
<li>writeAsCsv(…)/ CsvOutputFormat-将元组写为逗号分隔的值文件。行和字段定界符是可配置的。每个字段的值来自对象的toString（）方法。</li>
<li>print()/ printToErr()- 在标准输出/标准错误流上打印每个元素的toString（）值。</li>
<li>write()/ FileOutputFormat-自定义文件输出的方法和基类。支持自定义对象到字节的转换。</li>
<li>output()// OutputFormat-最通用的输出方法，用于不基于文件的数据接收器（例如将结果存储在数据库中）。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// text data</span></span><br><span class="line">val textData: DataSet[String] = <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// write DataSet to a file on the local file system</span></span><br><span class="line">textData.writeAsText(<span class="string">"file:///my/result/on/localFS"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// write DataSet to a file on a HDFS with a namenode running at nnHost:nnPort</span></span><br><span class="line">textData.writeAsText(<span class="string">"hdfs://nnHost:nnPort/my/result/on/localFS"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// write DataSet to a file and overwrite the file if it exists</span></span><br><span class="line">textData.writeAsText(<span class="string">"file:///my/result/on/localFS"</span>, WriteMode.OVERWRITE)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tuples as lines with pipe as the separator "a|b|c"</span></span><br><span class="line">val values: DataSet[(String, Int, Double)] = <span class="comment">// [...]</span></span><br><span class="line">values.writeAsCsv(<span class="string">"file:///path/to/the/result/file"</span>, <span class="string">"\n"</span>, <span class="string">"|"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// this writes tuples in the text formatting "(a, b, c)", rather than as CSV lines</span></span><br><span class="line">values.writeAsText(<span class="string">"file:///path/to/the/result/file"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// this writes values as strings using a user-defined formatting</span></span><br><span class="line">values map &#123; tuple =&gt; tuple._1 + <span class="string">" - "</span> + tuple._2 &#125;</span><br><span class="line">  .writeAsText(<span class="string">"file:///path/to/the/result/file"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="12、flink的计数器"><a href="#12、flink的计数器" class="headerlink" title="12、flink的计数器"></a>12、flink的计数器</h1><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/api_concepts.html#accumulators--counters" target="_blank" rel="noopener">官方概念</a><br>类似于spark的累加器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.accumulators.LongCounter</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.RichMapFunction</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.core.fs.FileSystem.WriteMode</span><br><span class="line"></span><br><span class="line">object CountApp &#123;</span><br><span class="line">  <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line">    val data = env.fromElements(<span class="string">"dingyi"</span>, <span class="string">"zhagnsan"</span>, <span class="string">"wangwu"</span>, <span class="string">"lisi"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*data.map(new RichMapFunction[String, Long]() &#123;</span></span><br><span class="line"><span class="comment">      var counter = 0l</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      override def map(in: String): Long = &#123;</span></span><br><span class="line"><span class="comment">        counter = counter + 1</span></span><br><span class="line"><span class="comment">        println("counter:" + counter)</span></span><br><span class="line"><span class="comment">        counter</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    &#125;).setParallelism(3)//设置并行度为3</span></span><br><span class="line"><span class="comment">      .print()*/</span>  <span class="comment">//结果不为4</span></span><br><span class="line">    <span class="comment">//如果并行度大于1得话，counter得结果就不准确；就好比java多线程同时操控一个未加锁的变量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//解决：</span></span><br><span class="line">    val info = data.map(<span class="keyword">new</span> RichMapFunction[String,String]() &#123;</span><br><span class="line">      <span class="comment">//step1：定义累加器</span></span><br><span class="line">      val counter = <span class="keyword">new</span> LongCounter()</span><br><span class="line">      <span class="comment">//重新open方法</span></span><br><span class="line">      <span class="function">override def <span class="title">open</span><span class="params">(parameters: Configuration)</span>: Unit </span>= &#123;</span><br><span class="line">        <span class="comment">//step2：注册计数器</span></span><br><span class="line">        getRuntimeContext.addAccumulator(<span class="string">"ele-counts-scala"</span>,counter)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function">override def <span class="title">map</span><span class="params">(in: String)</span>: String </span>= &#123;</span><br><span class="line">        counter.add(<span class="number">1</span>)</span><br><span class="line">        in</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    info.writeAsText(<span class="string">"test_files\\output\\sink-scala-count\\"</span>,WriteMode.OVERWRITE).setParallelism(<span class="number">3</span>)</span><br><span class="line">    val jobResult = env.execute(<span class="string">"CountApp"</span>)</span><br><span class="line">    <span class="comment">//拿到我们注册的计数器</span></span><br><span class="line">    val num = jobResult.getAccumulatorResult[Long](<span class="string">"ele-counts-scala"</span>)</span><br><span class="line">    println(<span class="string">"num:"</span>+num)<span class="comment">//结果为4</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="13、分布式缓存"><a href="#13、分布式缓存" class="headerlink" title="13、分布式缓存"></a>13、分布式缓存</h1><p>Flink提供了一个分布式缓存，类似于Apache Hadoop，使文件本地可访问用户函数的并行实例。此功能可用于共享包含静态外部数据(如字典或机器学习的回归模型)的文件。</p>
<p>缓存的工作原理如下。程序在其执行环境中以特定名称注册本地或远程文件系统(如HDFS或S3)的文件或目录作为缓存文件。当程序执行时，Flink自动将文件或目录复制到所有worker的本地文件系统。用户函数可以查找指定名称下的文件或目录，并从worker的本地文件系统中访问它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.RichMapFunction</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration</span><br><span class="line"></span><br><span class="line">object DistributedCacheApp &#123;</span><br><span class="line">  <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    val filePath = <span class="string">"test_files\\test_file\\test01.txt"</span></span><br><span class="line">    <span class="comment">//step1:注册一个本地文件</span></span><br><span class="line">    env.registerCachedFile(filePath, <span class="string">"kun-scala-dc"</span>)</span><br><span class="line"></span><br><span class="line">    val data = env.fromElements(<span class="string">"dingyi"</span>, <span class="string">"zhagnsan"</span>, <span class="string">"wangwu"</span>, <span class="string">"lisi"</span>)</span><br><span class="line">    data.map(<span class="keyword">new</span> RichMapFunction[String, String] &#123;</span><br><span class="line">      <span class="comment">//step2:在open方法中获取到分布式缓存的内容即可</span></span><br><span class="line">      <span class="function">override def <span class="title">open</span><span class="params">(config: Configuration)</span>: Unit </span>= &#123;</span><br><span class="line">        val dcFile = getRuntimeContext.getDistributedCache.getFile(<span class="string">"kun-scala-dc"</span>)</span><br><span class="line">        val lines = FileUtils.readLines(dcFile)</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">          * 此时会出现一个异常：java集合和scala结婚不兼容</span></span><br><span class="line"><span class="comment">          * 需要添加import scala.collection.JavaConversions._</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        <span class="keyword">import</span> scala.collection.JavaConversions._</span><br><span class="line">        <span class="keyword">for</span> (ele &lt;- lines) &#123;</span><br><span class="line">          println(ele)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function">override def <span class="title">map</span><span class="params">(value: String)</span>: String </span>= &#123;</span><br><span class="line">        value</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="14、广播变量"><a href="#14、广播变量" class="headerlink" title="14、广播变量"></a>14、广播变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kun.flink.chapter04</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.RichMapFunction</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration</span><br><span class="line"></span><br><span class="line">object BroadcastApp &#123;</span><br><span class="line">  <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">    val env = ExecutionEnvironment.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. The DataSet to be broadcast</span></span><br><span class="line">    val toBroadcast = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    val data = env.fromElements(<span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line"></span><br><span class="line">    data.map(<span class="keyword">new</span> RichMapFunction[String, (String, String)]() &#123;</span><br><span class="line">      <span class="keyword">var</span> broadcastSet: Traversable[Int] = <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">      <span class="function">override def <span class="title">open</span><span class="params">(config: Configuration)</span>: Unit </span>= &#123;</span><br><span class="line">        <span class="comment">// 3. Access the broadcast DataSet as a Collection</span></span><br><span class="line">        <span class="keyword">import</span> scala.collection.JavaConverters._ <span class="comment">//asScala需要使用隐式转换</span></span><br><span class="line">        broadcastSet = getRuntimeContext().getBroadcastVariable[Int](<span class="string">"broadcastSetName"</span>).asScala</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function">def <span class="title">map</span><span class="params">(in: String)</span>: <span class="params">(String, String)</span> </span>= &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> (broadVariable &lt;- broadcastSet) &#123;</span><br><span class="line">          result = result+broadVariable+<span class="string">" "</span></span><br><span class="line">        &#125;</span><br><span class="line">        (in, result)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).withBroadcastSet(toBroadcast, <span class="string">"broadcastSetName"</span>).print() <span class="comment">// 2. Broadcast the DataSet</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果<br>将广播变量1 2 3 广播了出去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(a,1 2 3 )</span><br><span class="line">(b,1 2 3 )</span><br></pre></td></tr></table></figure>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/article/[Flink] DataStream API/" data-toggle="tooltip" data-placement="top" title="[Flink] DataStream API">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/article/[Flink] 编程模型以及核心概念/" data-toggle="tooltip" data-placement="top" title="[Flink] 编程模型以及核心概念">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                    <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


<!-- chrome Firefox 中文锚点定位失效-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a',function(a){
            // var isChrome = window.navigator.userAgent.indexOf("Chrome") !== -1;
            // console.log(window.navigator.userAgent,isChrome)
                // if(isChrome) {
                    // console.log(a.currentTarget.outerHTML);
                    // console.log($(a.currentTarget).attr("href"));
                    //跳转到指定锚点
                    // document.getElementById(a.target.innerText.toLowerCase()).scrollIntoView(true);
                    document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
                // }
        })  
</script>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/li-yu-kun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 李玉坤 2020 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    By <a href="https://li-yu-kun.github.io/">李玉坤</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=li-yu-kun&repo=li-yu-kun.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://li-yu-kun.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'xxx';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>





	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://li-yu-kun.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
